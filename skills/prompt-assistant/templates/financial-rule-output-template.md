# 财务规则集输出格式化模板

## 模板目的
用于处理财务粉饰规则集的结果，生成结构化的markdown表格输出，包含规则、子规则及风险提示。

## 模板结构

```
# [规则集名称]

## 规则集概览
| 指标 | 值 |
|-----|-----|
| 总规则数 | {total} |
| 执行成功 | {succeeded} |
| 执行失败 | {failed} |
| 执行时间 | {time}s |

## 规则执行结果

### 规则汇总表

| 编码 | 规则名称 | 状态 | 判断逻辑 | 风险提示 |
|-----|--------|------|---------|--------|
| {code} | {name} | {status} | {logic} | {risk_summary} |

**状态说明：**
- ✅ success：规则执行成功，无风险
- ⚠️ warning：规则执行成功，存在预警信息
- ❌ error：规则执行失败，缺少必要数据
- ❌ failed：规则执行成功，触发风险

### 子规则详情表

| 编码 | 子规则名称 | 状态 | 实际值 | 阈值 | 说明 |
|-----|---------|------|--------|------|------|
| {code} | {name} | {status} | {value} | {threshold} | {description} |

**说明详见下一节**

---

## 风险提示详细说明

### [规则编码：规则名称]

**判断逻辑：** `{logic_expression}`

**风险提示：**
{risk_message_with_subrule_logic}

**触发的子规则：**
- {subrule1_code}：{subrule1_description}
- {logic_operator} {subrule2_code}：{subrule2_description}
- {logic_operator} {subrule3_code}：{subrule3_description}

---

## 风险提示输出规范

风险提示应按照以下格式输出：

```
[风险提示]。[触发子规则1说明]；[逻辑关系：或/且/非][触发子规则2说明]。
```

### 样例格式说明
- **风险提示**：规则触发的核心风险描述
- **触发子规则说明**：具体的子规则执行结果及数据对比
- **逻辑关系**：子规则之间的组合关系
  - **且**：多个子规则同时触发风险
  - **或**：多个子规则中任一触发风险
  - **非**：排除某个条件的影响

### 真实样例

**销售毛利率、销售集中度和采购集中度分析：**

存在销售渠道集中风险和经营现金流异常。销售集中度异常，前五大客户销售占比为10.67%，超过阈值10%，表明销售渠道过于集中，存在重大客户依赖风险；且经营活动现金流量净额/净利润为-3.92，远低于正常水平1.0，现金流与利润严重不匹配，表明收入质量存在问题；且存货周转天数同比增长25.17%，超过20%，存货周转速度明显放缓，存货管理效率下降。

---

## 使用步骤

### Step 1：准备规则集结果
从规则引擎获取JSON格式的规则集执行结果，包含：
- 规则集元信息（code, name, description）
- 规则列表（每个规则包含code, name, status, logic_expression, risk_message）
- 子规则列表（每个子规则包含code, name, status, value, threshold, description）

### Step 2：生成规则汇总表
遍历rules数组，按以下规则填充表格：
- 编码：`rule.code`
- 规则名称：`rule.name`
- 状态：根据`rule.status`映射为emoji + status
- 判断逻辑：`rule.logic_expression`
- 风险提示：从`rule.risk_message`和相关子规则拼接生成（见Step 3）

### Step 3：生成风险提示（核心流程）
对于每个status为"failed"或"warning"的规则：

1. **提取触发的子规则**
   - 解析`logic_expression`中的子规则代码（如FF-0002, IB-0002等）
   - 从sub_rules中查找这些子规则的详细信息
   - 筛选状态为"failed"或"warning"的子规则

2. **构建风险提示文本**
   - 开头：[规则基础风险提示]（来自rule.risk_message的摘要）
   - 中间：[触发子规则1说明]。[逻辑关系][触发子规则2说明]。...
   - 逻辑关系的确定：
     - 如果logic中是AND：使用"且"
     - 如果logic中是OR：使用"或"
     - 如果logic中是NOT：使用"非"或"不存在"

3. **子规则说明的组织**
   - 对于status="failed"的子规则：使用"实际值与阈值对比+风险描述"
   - 对于status="warning"的子规则：使用"潜在风险+具体现象"
   - 对于status="n/a"的子规则：使用"缺少数据：字段名"

### Step 4：生成子规则详情表
遍历sub_rules数组，填充子规则表格，仅展示：
- status为"failed"或"warning"的子规则
- 或者与某个failed规则相关的所有子规则

### Step 5：输出最终结果
按照上述模板结构组织markdown：
1. 规则集概览
2. 规则执行结果表格
3. 风险提示详细说明
4. 子规则详情（可选）

---

## 关键规则

- **表格对齐**：使用markdown标准表格格式，每列用|分隔
- **状态映射**：
  - success → ✅ 成功
  - error → ❌ 失败（缺数据）
  - failed → ❌ 失败（触发风险）
  - warning → ⚠️ 预警
  - n/a → ⚠️ 暂无数据
- **风险提示的优先级**：failed > warning > error > success
- **子规则聚合**：风险提示中优先展示failed的子规则，其次warning
- **逻辑表达式处理**：保持原始表达式的逻辑关系，不要简化或修改

---

## 错误处理

- **缺少必要数据**：保持rule.risk_message的原始错误描述
- **子规则缺失**：在风险提示中标注"[数据缺失]"
- **逻辑表达式解析失败**：输出原始logic_expression，在脚注说明
